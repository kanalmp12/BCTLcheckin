<!doctype html>
<html lang="th">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>เช็คชื่อห้องประชุม • BUCA Talent</title>
    <meta name="description"
        content="หน้าเช็คชื่อเข้าประชุมแบบเบา เร็ว ปลอดเฟรมเวิร์ก เก็บข้อมูลลง Google Sheets พร้อมล็อกรัศมีไม่เกิน 50 เมตรจากห้องประชุม.">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#fdfcff">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1a1c1e">

    <!-- Material Design 3 Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <!-- Favicon -->
    <link rel="icon" href="Images/Favicon.png" type="image/png">

    <style>
        :root {
            /* MD3 Light Theme Tokens - Blue */
            --md-sys-color-primary: #0061a4;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #d1e4ff;
            --md-sys-color-on-primary-container: #001d36;
            --md-sys-color-surface: #fdfcff;
            --md-sys-color-on-surface: #1a1c1e;
            --md-sys-color-surface-container: #f0f4f9;
            --md-sys-color-outline: #73777f;
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-on-error: #ffffff;

            --md-sys-typescale-headline-large: 400 32px/40px 'Roboto', sans-serif;
            --md-sys-typescale-headline: 400 24px/32px 'Roboto', sans-serif;
            --md-sys-typescale-title: 500 20px/28px 'Roboto', sans-serif;
            --md-sys-typescale-body: 400 16px/24px 'Roboto', sans-serif;
            --md-sys-typescale-label: 500 14px/20px 'Roboto', sans-serif;
            --md-sys-typescale-label-small: 500 12px/16px 'Roboto', sans-serif;

            --radius-medium: 12px;
            --radius-full: 999px;

            /* Backward compatibility for JS */
            --brand: var(--md-sys-color-primary);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                /* MD3 Dark Theme Tokens - Blue */
                --md-sys-color-primary: #9ecaff;
                --md-sys-color-on-primary: #003258;
                --md-sys-color-primary-container: #00497d;
                --md-sys-color-on-primary-container: #d1e4ff;
                --md-sys-color-surface: #1a1c1e;
                --md-sys-color-on-surface: #e2e2e6;
                --md-sys-color-surface-container: #1e2022;
                --md-sys-color-outline: #8c9199;
                --md-sys-color-error: #ffb4ab;
                --md-sys-color-on-error: #690005;

                --brand: var(--md-sys-color-primary);
            }
        }

        * {
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            margin: 0;
            font: var(--md-sys-typescale-body);
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 720px;
            margin: auto;
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Typography */
        h1,
        h2 {
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h1 {
            font: var(--md-sys-typescale-headline-large);
        }

        h2 {
            font: var(--md-sys-typescale-headline);
        }

        .lead {
            font: var(--md-sys-typescale-body);
            opacity: 0.9;
            margin-bottom: 24px;
        }

        a {
            color: inherit;
        }

        /* Material Symbols */
        .icon {
            font-family: 'Material Symbols Outlined';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
        }

        /* Card Component */
        .card {
            background-color: var(--md-sys-color-surface-container);
            border-radius: var(--radius-medium);
            padding: 24px;
            box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15), 0px 1px 2px 0px rgba(0, 0, 0, 0.3);
        }

        /* Form Layout */
        .row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }

        @media (min-width: 600px) {
            .row {
                grid-template-columns: 1fr 1fr;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        label {
            font: var(--md-sys-typescale-label);
            color: var(--md-sys-color-on-surface);
            margin-bottom: 8px;
            display: block;
        }

        /* Text Field & Select Components */
        input,
        select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 4px;
            /* MD3 text field radius */
            background-color: transparent;
            color: var(--md-sys-color-on-surface);
            font: inherit;
            box-sizing: border-box;
            transition: border-color 0.2s;
            appearance: none;
        }

        select {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="%2389938d"><path d="M480-360 280-560h400L480-360Z"/></svg>') no-repeat right 12px center;
            background-size: 24px;
        }

        @media (prefers-color-scheme: light) {
            select {
                background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="%236f7975"><path d="M480-360 280-560h400L480-360Z"/></svg>') no-repeat right 12px center;
            }
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            border-width: 2px;
            padding: 13px 15px;
            /* Adjust for border thickness */
        }

        /* Distance Output */
        output {
            font: inherit;
            display: block;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 4px;
            padding: 14px 16px;
            background-color: transparent;
            text-align: center;
        }

        /* Filled Button Component */
        button {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            border-radius: var(--radius-full);
            padding: 12px 24px;
            font: var(--md-sys-typescale-label);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: box-shadow 0.2s, opacity 0.2s, background-color 0.2s;
        }

        button:hover:not(:disabled) {
            box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            opacity: 0.9;
        }

        button:active:not(:disabled) {
            opacity: 0.8;
            box-shadow: none;
        }

        button:disabled {
            background-color: rgba(25, 28, 27, 0.12);
            color: rgba(25, 28, 27, 0.38);
            cursor: not-allowed;
            box-shadow: none;
        }

        @media (prefers-color-scheme: dark) {
            button:disabled {
                background-color: rgba(225, 227, 224, 0.12);
                color: rgba(225, 227, 224, 0.38);
            }
        }

        /* Utilities */
        .muted {
            font: var(--md-sys-typescale-label-small);
            color: var(--md-sys-color-outline);
            margin-top: 8px;
            display: block;
            text-align: center;
        }

        .pill {
            font: var(--md-sys-typescale-label-small);
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--radius-full);
            padding: 4px 10px;
            display: inline-block;
        }

        .kpi {
            display: flex;
            gap: 10px;
            align-items: center;
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            padding: 16px;
            border-radius: var(--radius-medium);
            margin: 24px 0;
            font-weight: 500;
        }

        .sr-only {
            position: absolute;
            left: -10000px;
            top: auto;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }

        /* Circular Progress Indicator */
        .md-circular-progress {
            width: 24px;
            height: 24px;
            animation: md-circular-progress-rotate 2s linear infinite;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            color: inherit;
        }

        .md-circular-progress svg {
            width: 100%;
            height: 100%;
        }

        .md-circular-progress circle {
            stroke: currentColor;
            stroke-dasharray: 1, 200;
            stroke-dashoffset: 0;
            animation: md-circular-progress-dash 1.5s ease-in-out infinite;
            stroke-linecap: round;
        }

        @keyframes md-circular-progress-rotate {
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes md-circular-progress-dash {
            0% {
                stroke-dasharray: 1, 200;
                stroke-dashoffset: 0;
            }

            50% {
                stroke-dasharray: 89, 200;
                stroke-dashoffset: -35px;
            }

            100% {
                stroke-dasharray: 89, 200;
                stroke-dashoffset: -124px;
            }
        }

        header nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        header nav strong {
            font: var(--md-sys-typescale-title);
        }

        footer {
            text-align: center;
            padding: 24px 0;
        }

        footer a {
            color: var(--md-sys-color-primary);
            text-decoration: none;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                scroll-behavior: auto;
                transition: none !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <a class="sr-only" href="#main">ข้ามไปเนื้อหา</a>
        <header role="banner" aria-label="หัวข้อหน้า">
            <nav>
                <strong>Check‑in</strong>
                <span class="pill" aria-label="สถานะความพร้อม">เวอร์ชัน • 011826</span>
            </nav>
            <h1><span class="icon">location_on</span> เช็คชื่อห้องประชุม BUCA Talent</h1>
            <p class="lead">กรุณาอนุญาตการเข้าถึงตำแหน่งอุปกรณ์ของคุณ</p>
        </header>

        <main id="main" role="main" style="display: flex; flex-direction: column; gap: 24px;">
            <section class="card" aria-labelledby="form-title">
                <h2 id="form-title"><span class="icon">person</span> ยืนยันตัวตน &amp; ตำแหน่ง</h2>
                <form id="checkin" aria-describedby="help">
                    <fieldset style="border:0;padding:0;margin:0" class="row">
                        <legend class="sr-only">ข้อมูลผู้เข้าร่วม</legend>
                        <div class="form-group">
                            <label for="name">ชื่อเล่น</label>
                            <input id="name" name="name" autocomplete="name" required placeholder="เช่น รูบี้จัง">
                        </div>
                        <div class="form-group">
                            <label for="dept">ฝ่าย</label>
                            <select id="dept" name="dept" required>
                                <option value="" selected="selected" disabled="disabled">เลือกฝ่าย</option>
                                <option value="Organize">ORGANIZE (OG)</option>
                                <option value="Public Relations">PUBLIC RELATIONS (PR)</option>
                                <option value="Production">MEDIA PRODUCTION (PRO)</option>
                                <option value="Visual Arts">VISUAL ART (VFX)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cohort">รุ่น</label>
                            <select id="cohort" name="cohort" required>
                                <option value="" selected="selected" disabled="disabled">เลือกรุ่น</option>
                                <option value="12">รุ่น 12</option>
                                <option value="13">รุ่น 13</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="distance">ระยะห่างจากห้อง (เมตร)</label>
                            <output id="distance" name="distance" aria-live="polite">–</output>
                        </div>
                        <input type="text" id="website" name="website" class="sr-only" tabindex="-1" autocomplete="off"
                            aria-hidden="true">
                    </fieldset>

                    <div class="kpi" aria-live="polite" aria-atomic="true">
                        <span id="status-icon" class="md-circular-progress">
                            <svg viewBox="22 22 44 44">
                                <circle cx="44" cy="44" r="20.2" fill="none" stroke-width="3.6"></circle>
                            </svg>
                        </span>
                        <span id="status">กำลังรอการตั้งค่าระบบ...</span>
                    </div>

                    <div>
                        <button id="submit" type="submit" disabled="disabled" aria-disabled="true">
                            <span class="icon">how_to_reg</span> เช็คชื่อ
                        </button>
                        <span class="muted" id="help">ระบบจะบันทึกเวลาและตำแหน่งปัจจุบัน</span>
                    </div>
                </form>
            </section>
            <section class="card" aria-labelledby="sec2">
                <h2 id="sec2"><span class="icon">shield</span> ข้อมูลและความเป็นส่วนตัว</h2>
                <p class="muted" style="text-align: left; font-size: 14px; margin-top: 0;">ระบบจะบันทึก: เวลา, ชื่อ,
                    ฝ่าย, รุ่น, พิกัด (lat, lng), ความคลาดเคลื่อน, ระยะห่างจากห้อง และ User‑Agent เพื่อความปลอดภัย</p>
            </section>
        </main>
        <footer role="contentinfo">
            <p class="muted">© <span id="year"></span> BUCA Talent | <a href="#"
                    rel="noopener">นโยบายความเป็นส่วนตัว</a></p>
        </footer>
    </div>
    <noscript>
        <p style="text-align: center; padding: 20px;">จำเป็นต้องเปิดใช้งาน JavaScript เพื่อเช็คชื่อและยืนยันรัศมี</p>
    </noscript>

    <script src="config.js"></script>
    <script>
        !function () {
            "use strict";
            const t = {
                form: document.getElementById("checkin"),
                name: document.getElementById("name"),
                dept: document.getElementById("dept"),
                cohort: document.getElementById("cohort"),
                submitBtn: document.getElementById("submit"),
                distOutput: document.getElementById("distance"),
                status: document.getElementById("status"),
                statusIcon: document.getElementById("status-icon"),
                year: document.getElementById("year")
            };

            t.year.textContent = (new Date).getFullYear();
            let e = { targetLat: null, targetLng: null, scriptUrl: GOOGLE_SCRIPT_URL, isLoaded: !1 };
            const n = { lat: null, lng: null, acc: null, dist: null, ok: !1 };

            function updateIcon(type) {
                if (!t.statusIcon) return;
                if (type === 'loading') {
                    t.statusIcon.className = 'md-circular-progress';
                    t.statusIcon.innerHTML = '<svg viewBox="22 22 44 44"><circle cx="44" cy="44" r="20.2" fill="none" stroke-width="3.6"></circle></svg>';
                } else if (type === 'success') {
                    t.statusIcon.className = 'icon';
                    t.statusIcon.innerHTML = 'check_circle';
                } else if (type === 'error') {
                    t.statusIcon.className = 'icon';
                    t.statusIcon.innerHTML = 'error';
                } else if (type === 'info') {
                    t.statusIcon.className = 'icon';
                    t.statusIcon.innerHTML = 'info';
                }
            }

            function a(t) { return t * Math.PI / 180; }

            function o() {
                if (n.dist !== null) {
                    t.distOutput.value = Math.round(n.dist) + " m";
                }
                const a = t.name.value.trim() && t.dept.value && t.cohort.value;
                const o = e.isLoaded;
                t.submitBtn.disabled = !(n.ok && a && o);
                t.submitBtn.setAttribute("aria-disabled", t.submitBtn.disabled ? "true" : "false");
            }

            function s() {
                if ("geolocation" in navigator) {
                    t.status.textContent = "กำลังระบุตำแหน่ง...";
                    updateIcon('loading');
                    navigator.geolocation.getCurrentPosition(s => {
                        const r = s.coords;
                        n.lat = r.latitude;
                        n.lng = r.longitude;
                        n.acc = r.accuracy;

                        if (e.targetLat && e.targetLng) {
                            n.dist = function (t, e, n, o) {
                                const s = a(t), r = a(n), u = a(n - t), i = a(o - e), c = Math.sin(u / 2) * Math.sin(u / 2) + Math.cos(s) * Math.cos(r) * Math.sin(i / 2) * Math.sin(i / 2);
                                return 2 * Math.atan2(Math.sqrt(c), Math.sqrt(1 - c)) * 6371e3;
                            }(n.lat, n.lng, e.targetLat, e.targetLng);

                            n.ok = n.dist <= 50;

                            if (n.ok) {
                                t.status.textContent = "คุณอยู่ในรัศมีที่กำหนด ✅";
                                t.status.style.color = "var(--brand)";
                                updateIcon('success');
                            } else {
                                t.status.textContent = "อยู่นอกรัศมี 50 เมตร ❌";
                                t.status.style.color = "#d32f2f";
                                updateIcon('error');
                            }
                        } else {
                            t.status.textContent = "รอข้อมูลพิกัดเป้าหมาย...";
                            updateIcon('loading');
                        }
                        o();
                    }, err => {
                        t.status.textContent = err && err.message ? err.message : "ไม่สามารถระบุตำแหน่งได้";
                        t.status.style.color = "inherit";
                        updateIcon('error');
                    }, { enableHighAccuracy: !0, timeout: 1e4, maximumAge: 0 });
                } else {
                    t.status.textContent = "อุปกรณ์นี้ไม่รองรับตำแหน่ง";
                    updateIcon('error');
                }
            }

            document.addEventListener("DOMContentLoaded", async function () {
                if (!GOOGLE_SCRIPT_URL) {
                    t.status.textContent = "Error: Google Script URL not set in index.html";
                    updateIcon('error');
                    return;
                }

                try {
                    t.status.textContent = "กำลังเชื่อมต่อ Server...";
                    updateIcon('loading');
                    const connector = GOOGLE_SCRIPT_URL.includes('?') ? '&' : '?';
                    const n = await fetch(`${GOOGLE_SCRIPT_URL}${connector}action=getConfig`);
                    if (!n.ok) throw new Error(`Server Error: ${n.status} ${n.statusText}`);
                    const a = await n.json();

                    if (!a.targetLat || !a.targetLng) throw new Error("Incomplete Config: Missing Lat/Lng in Google Sheet");

                    const isOpen = String(a.isOpen).toLowerCase() === 'true';
                    if (!isOpen) {
                        window.location.href = "Maintenance.html";
                        return;
                    }

                    e.targetLat = parseFloat(a.targetLat);
                    e.targetLng = parseFloat(a.targetLng);
                    e.isLoaded = !0;
                    console.log("Config loaded via Google Apps Script");
                    s();
                } catch (e) {
                    console.error("Config Error:", e);
                    t.status.textContent = `โหลดค่าไม่สำเร็จ: ${e.message}`;
                    updateIcon('error');
                }
            });

            document.addEventListener("input", o);
            document.addEventListener("change", o);

            t.form.addEventListener("submit", async a => {
                if (a.preventDefault(), t.submitBtn.disabled) return;

                const s = document.getElementById("website");
                if (s && s.value) {
                    t.status.textContent = "บล็อกบอท";
                    updateIcon('error');
                    return;
                }

                t.submitBtn.disabled = !0;
                t.status.textContent = "กำลังบันทึก...";
                updateIcon('loading');

                const r = {
                    timestamp: (new Date).toISOString(),
                    name: t.name.value.trim(),
                    department: t.dept.value,
                    cohort: t.cohort.value,
                    lat: n.lat,
                    lng: n.lng,
                    accuracy: n.acc,
                    distance_m: Math.round(n.dist || 0),
                    ua: navigator.userAgent
                };

                try {
                    await fetch(e.scriptUrl, { method: "POST", mode: "no-cors", body: JSON.stringify(r) });
                    t.status.textContent = "เช็คชื่อเรียบร้อย ✔ พร้อมสำหรับคนถัดไป";
                    t.form.reset();
                    t.distOutput.value = Math.round(n.dist) + " m";
                    updateIcon('success');
                    o();
                } catch (e) {
                    t.status.textContent = "เกิดข้อผิดพลาดของเครือข่าย";
                    t.submitBtn.disabled = !1;
                    updateIcon('error');
                }
            });
        }()
    </script>
</body>

</html>